Nombre del conjunto: CP-F06-01 Favoritos y perfiles públicos
Fase: 06 - Social y Notificaciones
Objetivo: Confirmar que los usuarios puedan seguir/favoritar listados, plantillas y otros usuarios, y que los perfiles públicos reflejen correctamente la actividad social en diferentes dispositivos.

Pre-requisitos generales:
- Usuarios:
  * `qa.coleccionista@cromos.test` (actor principal).
  * `qa.vendedor@cromos.test` (propietario de listados).
  * `qa.creador@cromos.test` (autor de plantillas públicas).
- Contenido disponible:
  * Listado activo `listing_QA_001`.
  * Plantilla pública "Colección QA Liga 2025".
  * Perfil público del vendedor con rating.
- Acceso a tablas `favourites`, `profiles`.
- Herramientas: Chrome desktop, dispositivo móvil, lector de pantalla opcional.

Configuración previa:
- Asegurar que los contadores de favoritos estén en 0 para el contenido seleccionado (eliminar registros previos).
- Iniciar sesión como `qa.coleccionista`.

Caso CP-F06-01A: Favoritos de listados desde el grid
  Cobertura: Happy path; optimismo UI.
  Pasos:
    1. Navegar a `/marketplace`.
    2. Pulsar icono de corazón en tarjeta del listado.
    3. Actualizar la página.
  Criterios de éxito:
    - Icono cambia a estado "favorito" inmediatamente (sin flash).
    - Contador de favoritos de la tarjeta incrementa.
    - Registro creado en `favourites` con `target_type='listing'`.

  Validación en Supabase (SQL):
    ```sql
    -- Consulta para verificar que el favorito se creó correctamente
    SELECT f.target_type,
           f.target_id,
           f.user_id,
           f.created_at
    FROM favourites f
    WHERE f.user_id = (
      SELECT id FROM auth.users 
      WHERE email = 'qa.coleccionista@cromos.test'
    )
    AND f.target_type = 'listing'
    AND f.target_id = [ID_DEL_LISTADO]
    ORDER BY f.created_at DESC
    LIMIT 1;
    ```
    **Instrucciones para ejecutar la consulta:**
    1. Iniciar sesión en Supabase Dashboard: https://app.supabase.com
    2. En el menú izquierdo, hacer clic en **"SQL Editor"**
    3. Copiar la consulta anterior y pegarla en el editor
    4. Reemplazar `[ID_DEL_LISTADO]` con el ID real del listado
    5. Hacer clic en el botón **"Run"**
    6. Verificar que el resultado muestra `target_type = 'listing'` y el ID correcto

    **Resultado esperado:** La consulta debe devolver el registro del favorito con el tipo y target_id correctos.

  Verificación en Chrome (consola):
    **Verificación en Chrome (consola):**
    1. En la página del marketplace, hacer clic derecho y seleccionar **Inspeccionar**.
    2. En la ventana que se abre, hacer clic en la pestaña **Console**.
    3. Hacer clic en el icono de corazón y observar que no aparecen errores.
    4. Tras marcar como favorito, verificar que el icono cambia de estado inmediatamente.
    5. En la pestaña **Network**, verificar que la petición para crear el favorito devuelve código 201.

    **Si hay errores:**
    1. Tomar captura de pantalla del error
    2. Copiar el mensaje de error (clic derecho → Copy message)
    3. Reportar en el seguimiento de prueba

    Para más ayuda sobre cómo ejecutar consultas SQL, ver: GUIA_DE_CONSULTAS_SQL.md
    Para más ayuda sobre cómo usar la consola de Chrome, ver: GUIA_DE_CONSOLA_CHROME.md

Caso CP-F06-01B: Favorito desde detalle y retiro
  Cobertura: Sincronización.
  Pasos:
    1. Abrir detalle del mismo listado.
    2. Verificar estado del botón (activo).
    3. Pulsar nuevamente para quitar favorito.
  Criterios de éxito:
    - Botón refleja estado actualizado en tiempo real.
    - Contador decrementa a valor inicial.
    - Registro en `favourites` se elimina.

  Validación en Supabase (SQL):
    ```sql
    -- Consulta para verificar que el favorito se eliminó
    SELECT COUNT(*) AS favoritos_activos
    FROM favourites f
    WHERE f.user_id = (
      SELECT id FROM auth.users 
      WHERE email = 'qa.coleccionista@cromos.test'
    )
    AND f.target_type = 'listing'
    AND f.target_id = [ID_DEL_LISTADO];
    ```
    **Instrucciones para ejecutar la consulta:**
    1. En Supabase Dashboard, ir a **SQL Editor**.
    2. Copiar la consulta anterior.
    3. Reemplazar `[ID_DEL_LISTADO]` con el ID real del listado.
    4. Hacer clic en **"Run"**.
    5. Verificar que el resultado es 0 (no hay favoritos activos).

    **Resultado esperado:** La consulta debe devolver 0, indicando que el favorito fue eliminado.

  Verificación en Chrome (consola):
    **Verificación en Chrome (consola):**
    1. En la página de detalle del listado, hacer clic derecho → **Inspeccionar**.
    2. Cambiar a la pestaña **Console**.
    3. Quitar el favorito y observar que no aparecen errores.
    4. Tras quitar, verificar que el botón cambia de estado inmediatamente.
    5. En la pestaña **Network**, verificar que la petición para eliminar el favorito devuelve código 200.

    **Si hay errores:**
    1. Buscar mensajes de error en la consola
    2. Verificar que la petición de eliminación devuelve código 200

    Para más ayuda sobre cómo ejecutar consultas SQL, ver: GUIA_DE_CONSULTAS_SQL.md
    Para más ayuda sobre cómo usar la consola de Chrome, ver: GUIA_DE_CONSOLA_CHROME.md

Caso CP-F06-01C: Favoritos de plantillas
  Cobertura: Diversos tipos.
  Pasos:
    1. Entrar a `/templates` y marcar favorita "Colección QA Liga 2025".
    2. Revisar en `/favoritos/plantillas`.
  Criterios de éxito:
    - Plantilla aparece en lista con datos correctos (autor, rating).
    - Contadores se actualizan en tarjeta pública.

  Validación en Supabase (SQL):
    ```sql
    -- Consulta para verificar que el favorito de plantilla se creó
    SELECT f.target_type,
           f.target_id,
           f.user_id,
           f.created_at
    FROM favourites f
    WHERE f.user_id = (
      SELECT id FROM auth.users 
      WHERE email = 'qa.coleccionista@cromos.test'
    )
    AND f.target_type = 'template'
    AND f.target_id = [ID_DE_LA_PLANTILLA]
    ORDER BY f.created_at DESC
    LIMIT 1;
    ```
    **Instrucciones para ejecutar la consulta:**
    1. En Supabase Dashboard, ir a **SQL Editor**.
    2. Copiar la consulta anterior.
    3. Reemplazar `[ID_DE_LA_PLANTILLA]` con el ID real de la plantilla.
    4. Hacer clic en **"Run"**.
    5. Verificar que el resultado muestra `target_type = 'template'` y el ID correcto.

    **Resultado esperado:** La consulta debe devolver el registro del favorito de plantilla.

  Verificación en Chrome (consola):
    **Verificación en Chrome (consola):**
    1. En la página de plantillas, hacer clic derecho → **Inspeccionar**.
    2. Cambiar a la pestaña **Console**.
    3. Marcar la plantilla como favorita y observar que no aparecen errores.
    4. Tras marcar, verificar que el icono cambia de estado.
    5. En la pestaña **Network**, verificar que la petición devuelve código 201.

    **Si hay errores:**
    1. Buscar mensajes de error en la consola
    2. Verificar que la petición de favorito devuelve código 201

    Para más ayuda sobre cómo ejecutar consultas SQL, ver: GUIA_DE_CONSULTAS_SQL.md
    Para más ayuda sobre cómo usar la consola de Chrome, ver: GUIA_DE_CONSOLA_CHROME.md

Caso CP-F06-01D: Seguir a un usuario
  Cobertura: Favoritos sobre perfiles.
  Pasos:
    1. Abrir `/usuarios/{id}` del vendedor.
    2. Pulsar "Agregar a favoritos".
    3. Revisar `/favoritos/usuarios`.
  Criterios de éxito:
    - Perfil aparece en lista con métricas (listados activos, calificación).
    - En el perfil público, contador de seguidores incrementa.
    - Botón cambia a "Eliminar de favoritos".

  Validación en Supabase (SQL):
    ```sql
    -- Consulta para verificar que el seguimiento de usuario se creó
    SELECT f.target_type,
           f.target_id,
           f.user_id,
           f.created_at
    FROM favourites f
    WHERE f.user_id = (
      SELECT id FROM auth.users 
      WHERE email = 'qa.coleccionista@cromos.test'
    )
    AND f.target_type = 'user'
    AND f.target_id = [ID_DEL_USUARIO_SEGUIDO]
    ORDER BY f.created_at DESC
    LIMIT 1;
    ```
    **Instrucciones para ejecutar la consulta:**
    1. En Supabase Dashboard, ir a **SQL Editor**.
    2. Copiar la consulta anterior.
    3. Reemplazar `[ID_DEL_USUARIO_SEGUIDO]` con el ID real del usuario seguido.
    4. Hacer clic en **"Run"**.
    5. Verificar que el resultado muestra `target_type = 'user'` y el ID correcto.

    **Resultado esperado:** La consulta debe devolver el registro del seguimiento de usuario.

  Verificación en Chrome (consola):
    **Verificación en Chrome (consola):**
    1. En la página del perfil del usuario, hacer clic derecho → **Inspeccionar**.
    2. Cambiar a la pestaña **Console**.
    3. Seguir al usuario y observar que no aparecen errores.
    4. Tras seguir, verificar que el botón cambia de estado.
    5. En la pestaña **Network**, verificar que la petición devuelve código 201.

    **Si hay errores:**
    1. Buscar mensajes de error en la consola
    2. Verificar que la petición de seguimiento devuelve código 201

    Para más ayuda sobre cómo ejecutar consultas SQL, ver: GUIA_DE_CONSULTAS_SQL.md
    Para más ayuda sobre cómo usar la consola de Chrome, ver: GUIA_DE_CONSOLA_CHROME.md

Caso CP-F06-01E: Página de favoritos consolidada
  Cobertura: UX; tabulación.
  Pasos:
    1. Visitar `/favoritos`.
    2. Revisar pestañas (Listados, Plantillas, Usuarios).
    3. Cambiar entre ellas en desktop y mobile.
  Criterios de éxito:
    - Cada tab muestra datos correctos y ordenados recientemente.
    - En mobile, tabs se convierten en un menú deslizante accesible.
    - Mensaje "Aún no tienes favoritos" aparece cuando aplica.

  Verificación en Chrome (consola):
    **Verificación en Chrome (consola):**
    1. En la página de favoritos, hacer clic derecho → **Inspeccionar**.
    2. Cambiar a la pestaña **Console**.
    3. Cambiar entre las pestañas y observar que no aparecen errores.
    4. En modo móvil (F12 → Toggle device toolbar), verificar que el menú deslizante funciona.
    5. En la pestaña **Network**, verificar que las peticiones de carga devuelven código 200.

    **Si hay errores:**
    1. Buscar mensajes de error en la consola
    2. Verificar que las pestañas se cargan correctamente

    Para más ayuda sobre cómo usar la consola de Chrome, ver: GUIA_DE_CONSOLA_CHROME.md

Caso CP-F06-01F: Sincronización multi-dispositivo
  Cobertura: Realtime; consistencia.
  Pasos:
    1. Marcar favorito en desktop.
    2. Abrir el mismo recurso en móvil (sin refrescar).
  Criterios de éxito:
    - Estado se sincroniza automáticamente (o tras refresh, sin inconsistencias).
    - No se crean registros duplicados.

  Verificación en Chrome (consola):
    **Verificación en Chrome (consola):**
    1. En Chrome desktop, presionar **F12** para abrir DevTools.
    2. Cambiar a la pestaña **Network** y filtrar por WebSocket.
    3. Marcar favorito en desktop y observar los mensajes de sincronización.
    4. En modo móvil (Toggle device toolbar), verificar que el estado se actualiza.
    5. Observar que no hay inconsistencias entre dispositivos.

    **Si hay errores:**
    1. Buscar mensajes de error de WebSocket en la consola
    2. Verificar que la sincronización funciona correctamente

    Para más ayuda sobre cómo usar la consola de Chrome, ver: GUIA_DE_CONSOLA_CHROME.md

Caso CP-F06-01G: Restricciones y seguridad
  Cobertura: Edge.
  Pasos:
    1. Usuario sin sesión intenta marcar favorito → debe ser redirigido a login.
    2. Autor de plantilla intenta auto-favoritarse (si el sistema lo permite).
  Criterios de éxito:
    - Se muestra mensaje "Inicia sesión para guardar favoritos".
    - Si se permite auto-favorito, registro se crea; si no, se muestra mensaje "No puedes seguir tu propio perfil".

  Verificación en Chrome (consola):
    **Verificación en Chrome (consola):**
    1. Como usuario no autenticado, intentar marcar favorito.
    2. Hacer clic derecho → **Inspeccionar**.
    3. Cambiar a la pestaña **Console**.
    4. Verificar que aparece redirección a login o mensaje adecuado.
    5. Intentar auto-favoritarse y observar el comportamiento del sistema.

    **Si hay errores:**
    1. Buscar mensajes de error en la consola
    2. Verificar que las restricciones funcionan correctamente

    Para más ayuda sobre cómo usar la consola de Chrome, ver: GUIA_DE_CONSOLA_CHROME.md

Notas generales:
- Registrar cambios en `favourites` para revertir tras las pruebas.
- Documentar diferencias de copy/tooltip si se detectan inconsistencias en localización.
- Para todas las consultas, utilizar Supabase Dashboard → SQL Editor y actualizar los placeholders antes de ejecutar.
