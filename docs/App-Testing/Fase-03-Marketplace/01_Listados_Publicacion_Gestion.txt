Nombre del conjunto: CP-F03-01 Publicación y gestión de listados marketplace
Fase: 03 - Marketplace
Objetivo: Confirmar que los usuarios puedan crear, actualizar y administrar listados de cromos cumpliendo reglas de negocio, validaciones y estados (`borrador`, `activo`, `reservado`, `vendido`, `removido`).

Pre-requisitos generales:
- Usuario vendedor: `qa.vendedor@cromos.test` con duplicados disponibles en su copia de plantilla.
- Usuario comprador potencial: `qa.comprador@cromos.test`.
- Recursos multimedia: 
  * `cromo_bueno.jpg` (1200x1600, 1.5 MB).
  * `cromo_pesado.jpg` (3200x3200, 6 MB) para validar límites.
  * `cromo_invalido.gif` (animado) para validación de formato.
- Acceso a tablas `trade_listings`, `listing_transactions`.
- Herramientas: Chrome desktop, DevTools 425px (mobile), herramienta de red para inspeccionar uploads (`/storage/v1/object/listings`).

Configuración previa:
- Limpiar listados existentes del vendedor (opcional) o identificarlos para evitar interferencias.
- Verificar que el usuario vendedor tiene duplicados en al menos una copia para usar “Publicar duplicado” en pruebas posteriores.

Casos de prueba:

Caso CP-F03-01A: Crear listado desde formulario manual
  Cobertura: Flujo feliz; validaciones básicas; subida de imagen opcional.
  Pasos:
    1. Iniciar sesión como `qa.vendedor`.
    2. Navegar a `/marketplace/new`.
    3. Completar campos: título, descripción (>120 caract.), número de cromo, colección, precio, estado.
    4. Subir `cromo_bueno.jpg`.
    5. Publicar.
  Criterios de éxito:
    - Validaciones se muestran en español; campos obligatorios resaltados.
    - Imagen se procesa a WebP y se almacena en bucket `listings`.
    - Toast “Listado publicado” y redirección a detalle `/marketplace/{id}`.
    - Registro en `trade_listings` con `status = 'active'`, `image_url` no nulo.

Caso CP-F03-01B: Creación en móvil con captura de cámara (Sprint 13 - Nueva funcionalidad)
  Cobertura: Responsive; flows en pantalla pequeña; captura de cámara nativa.
  Pasos:
    1. Repetir flujo en viewport 375px o dispositivo físico.
    2. **NUEVO**: En el formulario de creación, verificar botón "Cámara" junto a "Subir imagen".
    3. **NUEVO**: Hacer clic en "Cámara" y otorgar permisos de cámara al navegador.
    4. **NUEVO**: Verificar preview en vivo de la cámara en modal.
    5. **NUEVO**: Capturar foto usando el botón de captura.
    6. **NUEVO**: Verificar preview de la foto capturada con opción "Usar esta foto" / "Volver a tomar".
    7. **NUEVO**: Confirmar uso de la foto y verificar que se procesa automáticamente (WebP, compresión).
    8. Alternativamente, usar archivo desde galería.
  Criterios de éxito:
    - Formulario utiliza acordeones o steps para facilitar navegación.
    - Botón "Publicar" siempre visible (sticky footer o similar).
    - Validaciones se muestran legibles sin recortes.
    - **NUEVO**: Botón "Cámara" visible solo en dispositivos con soporte de `getUserMedia`.
    - **NUEVO**: Modal de cámara muestra preview en vivo del feed.
    - **NUEVO**: Captura funciona correctamente sin flickering (corregido en Sprint 13).
    - **NUEVO**: Foto capturada se procesa a WebP con compresión <2MB y dimensiones máx 1600x1600.
    - **NUEVO**: Manejo correcto de errores de permisos con mensajes claros en español.
    - **NUEVO**: Stream de cámara se cierra correctamente al cancelar o completar captura.

Caso CP-F03-01C: Validaciones de archivo e inputs
  Cobertura: Errores en imagen y campos.
  Pasos:
    1. Intentar subir `cromo_pesado.jpg`.
    2. Intentar subir `cromo_invalido.gif`.
    3. Enviar formulario sin completar campos clave.
  Criterios de éxito:
    - Se muestra error “El archivo supera 4 MB” y no se sube.
    - Formato GIF es rechazado con mensaje claro.
    - Botón publicar deshabilitado hasta completar campos requeridos.

Caso CP-F03-01D: Editar listado activo
  Cobertura: Actualización de datos; control de versiones.
  Pasos:
    1. Abrir listado creado y pulsar “Editar”.
    2. Cambiar precio, descripción y reemplazar imagen.
    3. Guardar.
    4. Revisar historial (si existe) y DB.
  Criterios de éxito:
    - Toast “Listado actualizado”.
    - `trade_listings` refleja nuevos valores y `updated_at` actualizado.
    - Imagen anterior se elimina o se marca para purga (ver storage).
    - Detalle de listado y tarjetas muestran info actualizada sin recargar manualmente.

Caso CP-F03-01E: Cambio de estado manual (remover/pausar)
  Cobertura: Estados `inactive`, `removed`.
  Pasos:
    1. En `/marketplace/my-listings`, mover listado a “Pausado”.
    2. Confirmar que desaparece del catálogo público.
    3. Cambiar a “Eliminado”.
  Criterios de éxito:
    - Tablero “Mis listados” refleja conteos por estado actualizados.
    - Listado deja de estar accesible públicamente (404 o mensaje).
    - `trade_listings.status` actualizado (`inactive` o `removed`), y se registra acción en `audit_log` (si aplica).

Caso CP-F03-01F: Crear borrador y publicarlo después
  Cobertura: Guardado parcial; reanudación.
  Pasos:
    1. Guardar listado como borrador (botón “Guardar borrador”).
    2. Salir de la página.
    3. Volver a “Mis listados → Borradores”, editar y publicar.
  Criterios de éxito:
    - Borrador se muestra con badge y fecha de última edición.
    - Al publicar, se mueve automáticamente a tab “Activos”.
    - Ningún campo pierde información durante la transición.

Caso CP-F03-01G: Restricción para usuarios no verificados o suspendidos
  Cobertura: Permisos.
  Pasos:
    1. Intentar acceder al formulario sin sesión → debe redirigir a login.
    2. Intentar publicar con usuario suspendido (usar `qa.suspendido`).
  Criterios de éxito:
    - Sistema bloquea acceso con mensaje “Debes iniciar sesión”.
    - Usuario suspendido ve alerta “Tu cuenta está suspendida, no puedes publicar”.
    - No se crea registro en base de datos.

Caso CP-F03-01H: Verificación de datos obligatorios en BD
  Cobertura: Integridad.
  Pasos:
    1. Revisar `trade_listings` para cada creación/edición.
    2. Confirmar que campos `views_count`, `favourites_count` inician en 0.
  Criterios de éxito:
    - Todos los campos obligatorios tienen valores válidos.
    - `author_id` corresponde al usuario correcto.
    - No hay registros huérfanos ni duplicados.

Notas generales:
- Mantener registro de IDs de listados para usar en pruebas de chat y reservas (CP-F03-02).
- Adjuntar evidencia de los estados en la planilla QA con timestamp y dispositivo usado.
