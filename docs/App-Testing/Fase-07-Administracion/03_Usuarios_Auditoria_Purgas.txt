Nombre del conjunto: CP-F07-03 Gestión de usuarios, auditoría y purga administrativa
Fase: 07 - Administración
Objetivo: Verificar que el módulo de usuarios admin permita búsquedas, suspensiones, restablecimientos de contraseña, purga total de datos y que el visor de auditoría refleje todas las acciones de forma precisa.

Pre-requisitos generales:
- Usuario admin `qa.admin@cromos.test`.
- Usuarios objetivo:
  * `qa.comprador@cromos.test` (usuario activo).
  * `qa.suspendido@cromos.test` (suspendido).
  * `qa.purgar@cromos.test` (creado solo para pruebas de purga, con datos de actividad: listados, plantillas, mensajes).
- Correo de soporte configurado para recibir enlaces de restablecimiento (Resend sandbox).
- Acceso a tablas `profiles`, `trade_listings`, `collection_templates`, `messages`, `audit_log`, `auth.users`.
- Herramientas: Chrome desktop, generador de requests (Hurl/Postman) para validar API admin.

Configuración previa:
- Crear datos para `qa.purgar` (al menos un listado, una plantilla, mensajes y favoritos) para comprobar la eliminación.
- Registrar recuento de registros asociados antes de purgar.

Casos de prueba:

Caso CP-F07-03A: Búsqueda y filtros en módulo de usuarios
  Cobertura: UX; rendimiento.
  Pasos:
    1. Navegar a `/admin/users`.
    2. Buscar por nickname (“comprador”) y por email completo.
    3. Aplicar filtros de estado (Activos, Suspendidos, Admins).
  Criterios de éxito:
    - Resultados aparecen con debounce (≤500 ms).
    - Tarjetas muestran avatar, email, estado, métricas (listados, reportes).
    - Filtro “Suspendidos” lista solo usuarios con `is_suspended = true`.

Caso CP-F07-03B: Suspender y reactivar usuario
  Cobertura: Acciones rápidas; notificaciones.
  Pasos:
    1. Seleccionar `qa.comprador`.
    2. Pulsar “Suspender” → ingresar motivo.
    3. Confirmar. Verificar acceso del usuario (intentar login en otra ventana).
    4. Pulsar “Reactivar”.
  Criterios de éxito:
    - `profiles.is_suspended` cambia y se registra `suspension_reason`.
    - Usuario suspendido no puede iniciar sesión (ver mensaje en pantalla).
    - Al reactivar, `is_suspended` vuelve a false y la UI lo refleja.
    - Audit log conserva ambas acciones (`suspend_user`, `unsuspend_user`).

Caso CP-F07-03C: Restablecimiento forzado de contraseña
  Cobertura: API interna; correo.
  Pasos:
    1. En tarjeta de `qa.comprador`, pulsar “Resetear contraseña”.
    2. Confirmar.
    3. Verificar recepción del correo (Resend/Mailhog) con enlace válido.
    4. Probar el enlace (opcional, en modo incognito).
  Criterios de éxito:
    - Endpoint `/api/admin/force-reset` responde 200.
    - Email llega con copy en español y enlace activo 1 hora.
    - Audit log registra `admin_force_password_reset`.

Caso CP-F07-03D: Purga completa de usuario
  Cobertura: Nueva función `admin_purge_user`.
  Pasos:
    1. Seleccionar `qa.purgar`.
    2. Pulsar “Eliminar usuario” → doble confirmación con motivo.
    3. Confirmar.
    4. Validar en BD que se eliminan registros relacionados:
       - Listados, plantillas, colecciones, ratings, mensajes, favoritos, transacciones, perfiles.
    5. Verificar que el usuario desaparece también de Supabase Auth (`auth.users`).
  Criterios de éxito:
    - UI muestra barra de progreso o estado de la operación.
    - Tras completar, usuario ya no aparece en búsquedas.
    - Consultas SQL devuelven 0 registros asociados.
    - Audit log registra `user_purge` con metadata detallada (`target_id`, `purged_at`).
    - Notificación interna (si existe) para equipo de soporte generada.

Caso CP-F07-03E: Visor de auditoría
  Cobertura: Paginación; filtros; corrección de valores de filtro (Sprint 14).
  Pasos:
    1. Abrir `/admin/audit`.
    2. Filtrar por acción `suspend_user`.
    3. Expandir un registro y revisar metadata JSON.
    4. **NUEVO (Sprint 14)**: Filtrar por acción "Resolve Report" y verificar que muestra reportes resueltos.
    5. **NUEVO (Sprint 14)**: Confirmar que el filtro usa el valor correcto `resolve_report` (no `dismiss_report`).
  Criterios de éxito:
    - Paginación infinita carga 20 registros por solicitud sin duplicados.
    - Filtrado por acción muestra solo coincidencias.
    - Metadata incluye `performed_by`, `target_type`, `reason`.
    - Opciones de exportación o copiado funcionan (si disponibles).
    - **NUEVO**: Filtro "Resolve Report" filtra correctamente por `moderation_action_type = 'resolve_report'`.
    - **NUEVO**: Los reportes resueltos aparecen con icono CheckCircle azul y badge "RESOLVE REPORT".
    - **NUEVO**: El mapeo entre UI y base de datos es consistente (resolve_report en ambos).

Caso CP-F07-03F: Seguridad de endpoints admin
  Cobertura: API sin privilegios.
  Pasos:
    1. Capturar request `POST /api/admin/delete-user`.
    2. Repetir con token de usuario normal (hurl/curl).
  Criterios de éxito:
    - Respuesta 403 y mensaje claro.
    - Ningún dato se altera.

Caso CP-F07-03G: Responsive del módulo usuarios y audit
  Cobertura: Mobile admin.
  Pasos:
    1. Revisar `/admin/users` y `/admin/audit` en 425px.
  Criterios de éxito:
    - Cards se apilan verticalmente.
    - Acciones críticas requieren confirmación incluso en móvil.

Notas generales:
- Tras purgar `qa.purgar`, recrear la cuenta si se necesitará más adelante (documentar pasos).
- Guardar extractos de `audit_log` posteriores a las acciones para adjuntar al informe.
