Nombre del conjunto: CP-F02-02 Copias, progreso y valoraciones de plantillas
Fase: 02 - Plantillas y Colecciones
Objetivo: Asegurar que los usuarios puedan copiar plantillas públicas, gestionar el progreso de cada slot, mantener el conteo de duplicados y emitir valoraciones sin violar restricciones de autoría.

Pre-requisitos generales:
- Plantilla pública "Colección QA Liga 2025" creada en CP-F02-01C.
- Usuario coleccionista: `qa.coleccionista@cromos.test` (sin copias previas).
- Usuario autor original: `qa.creador@cromos.test` (para verificar restricciones).
- Acceso a tablas `user_template_copies`, `user_template_progress`, `template_ratings`.
- Herramientas: Chrome desktop, Safari/Chrome móvil, planilla para seguimiento de conteos.

Configuración previa:
- Borrar registros previos en `user_template_copies` del usuario coleccionista.
- Verificar que la plantilla esté visible públicamente (`is_public = true`, `is_deleted = false`).
- Preparar datos de ejemplo para duplicados (p.ej. 3 cromos repetidos del slot 5).

Casos de prueba:

Caso CP-F02-02A: Copiar plantilla pública
  Cobertura: Happy path; inicialización de progreso.
  Pasos:
    1. Iniciar sesión con `qa.coleccionista`.
    2. Abrir `/templates/{id}` de la plantilla "Colección QA Liga 2025".
    3. Pulsar "Copiar plantilla".
    4. Asignar nombre personalizado "Mi Colección QA 2025".
    5. Confirmar y esperar redirección.
  Criterios de éxito:
    - Se crea registro en `user_template_copies` con `title` personalizado.
    - Redirección automática a `/mi-coleccion/{copyId}`.
    - Todos los slots se inicializan como 'missing' (count = 0).
    - Toast de éxito en español.

  Validación en Supabase (SQL):
    ```sql
    -- Consulta para verificar que la copia se creó correctamente
    SELECT utc.title,
           utc.is_active,
           utc.copied_at,
           p.title AS plantilla_original
    FROM user_template_copies utc
    JOIN collection_templates p ON p.id = utc.template_id
    WHERE utc.user_id = (
      SELECT id FROM auth.users 
      WHERE email = 'qa.coleccionista@cromos.test'
    )
    ORDER BY utc.copied_at DESC
    LIMIT 1;
    ```
    **Instrucciones para ejecutar la consulta:**
    1. Iniciar sesión en Supabase Dashboard: https://app.supabase.com
    2. En el menú izquierdo, hacer clic en **"SQL Editor"**
    3. Copiar la consulta anterior y pegarla en el editor
    4. Hacer clic en el botón **"Run"**
    5. Verificar que el resultado muestra `title` personalizado, `is_active = true` y el nombre de la plantilla original

    ```sql
    -- Consulta para verificar que todos los slots se inicializaron como 'missing'
    SELECT COUNT(*) AS slots_inicializados,
           SUM(CASE WHEN utp.status = 'missing' THEN 1 ELSE 0 END) AS slots_missing
    FROM user_template_progress utp
    WHERE utp.copy_id = (
      SELECT id FROM user_template_copies
      WHERE user_id = (
        SELECT id FROM auth.users 
        WHERE email = 'qa.coleccionista@cromos.test'
      )
      ORDER BY copied_at DESC
      LIMIT 1
    );
    ```
    **Instrucciones para ejecutar la consulta:**
    1. En el mismo SQL Editor, pegar esta segunda consulta
    2. Hacer clic en **"Run"**
    3. Verificar que `slots_inicializados` es igual al total de slots y `slots_missing` es igual al total

  **Resultado esperado:** La primera consulta debe mostrar la copia recién creada. La segunda debe mostrar todos los slots inicializados como 'missing'.

  Verificación en Chrome (consola):
    **Verificación en Chrome (consola):**
    1. En la página de la plantilla, hacer clic derecho y seleccionar **Inspeccionar**.
    2. En la ventana que se abre, hacer clic en la pestaña **Console**.
    3. Pulsar "Copiar plantilla" y observar que no aparecen errores en rojo.
    4. Tras la redirección, verificar que aparece mensaje de éxito como "Plantilla copiada correctamente".

    **Si hay errores:**
    1. Tomar captura de pantalla del error
    2. Copiar el mensaje de error (clic derecho → Copy message)
    3. Reportar en el seguimiento de prueba

    Para más ayuda sobre cómo ejecutar consultas SQL, ver: GUIA_DE_CONSULTAS_SQL.md
    Para más ayuda sobre cómo usar la consola de Chrome, ver: GUIA_DE_CONSOLA_CHROME.md

Caso CP-F02-02B: Actualizar progreso de slots (HAVE/NEED/DUPES)
  Cobertura: Interacciones; cálculos agregados; UI reactiva.
  Pasos:
    1. En `/mi-coleccion/{copyId}`, marcar slots 1-3 como "Tengo".
    2. Marcar slot 4 como "Repetido" con cantidad 2.
    3. Marcar slot 5 como "Necesito".
    4. Verificar contador global y badges de página.
    5. Repetir en móvil para verificar sincronización.
  Criterios de éxito:
    - Contadores de página se actualizan en tiempo real.
    - Badges (completo, repetidos) aparecen correctamente.
    - Estado persiste tras recargar página.
    - En móvil, la interfaz se adapta sin perder funcionalidad.

  Validación en Supabase (SQL):
    ```sql
    -- Consulta para verificar el estado actualizado de los slots
    SELECT utp.slot_id,
           tp.page_number || '.' || ts.slot_number AS referencia,
           utp.status,
           utp.count,
           utp.updated_at
    FROM user_template_progress utp
    JOIN template_slots ts ON ts.id = utp.slot_id
    JOIN template_pages tp ON tp.id = ts.page_id
    WHERE utp.copy_id = (
      SELECT id FROM user_template_copies
      WHERE user_id = (
        SELECT id FROM auth.users 
        WHERE email = 'qa.coleccionista@cromos.test'
      )
      ORDER BY copied_at DESC
      LIMIT 1
    )
    AND utp.slot_id IN (1, 2, 3, 4, 5)
    ORDER BY tp.page_number, ts.slot_number;
    ```
    **Instrucciones para ejecutar la consulta:**
    1. En Supabase Dashboard, ir a **SQL Editor**.
    2. Copiar y pegar la consulta anterior.
    3. Hacer clic en **"Run"**.
    4. Verificar que los slots 1-3 muestran `status = 'Tengo'` y `count = 1`, el slot 4 muestra `status = 'Repetido'` y `count = 2`, y el slot 5 muestra `status = 'Necesito'` y `count = 0`.

    **Resultado esperado:** Los estados y conteos deben coincidir exactamente con las acciones realizadas en la UI.

  Verificación en Chrome (consola):
    **Verificación en Chrome (consola):**
    1. En la vista de colección, hacer clic derecho y seleccionar **Inspeccionar**.
    2. Cambiar a la pestaña **Console**.
    3. Marcar cada slot y observar que las peticiones de actualización se envían sin errores.
    4. Verificar que los contadores en la UI se actualizan inmediatamente después de cada acción.

    **Si hay errores:**
    1. Buscar mensajes de error rojos en la consola
    2. Verificar que las peticiones a la API no devuelven código 500
    3. Reportar cualquier error de sincronización

    Para más ayuda sobre cómo ejecutar consultas SQL, ver: GUIA_DE_CONSULTAS_SQL.md
    Para más ayuda sobre cómo usar la consola de Chrome, ver: GUIA_DE_CONSOLA_CHROME.md

Caso CP-F02-02B2: Entrada rápida por número de checklist (Quick Entry)
  Cobertura: Modalidad simplificada; navegación por teclado; mapeo automático.
  Pasos:
    1. En vista de colección, pulsar botón "Entrada Rápida".
    2. Verificar que modal abre en modo "Por Número" (sin pestañas).
    3. Escribir "45" y presionar Enter → debe localizar slot 45A.
    4. Escribir "46" y presionar Enter → debe localizar slot 46.
    5. Escribir "999" y presionar Enter → debe mostrar mensaje de no encontrado.
    6. Escribir "1,2,3,4,5" y presionar Enter → debe actualizar múltiples slots.
    7. Verificar límite de entradas recientes (máximo 5).
    8. Probar en móvil (375px) para verificar responsividad.
  Criterios de éxito:
    - Campo de entrada mantiene foco automático.
    - Sistema localiza slots por número global si existe.
    - Mensajes de error claros y en español.
    - Lista de entradas recientes muestra últimas 5 actualizaciones.
    - Modal funciona en móvil sin cortes.

  Validación en Supabase (SQL):
    ```sql
    -- Consulta para verificar que el sistema encuentra el slot correcto
    SELECT ts.slot_number,
           ts.slot_variant,
           ts.global_number,
           tp.page_number,
           tp.title AS pagina_titulo
    FROM template_slots ts
    JOIN template_pages tp ON tp.id = ts.page_id
    WHERE ts.template_id = (
      SELECT template_id FROM user_template_copies
      WHERE user_id = (
        SELECT id FROM auth.users 
        WHERE email = 'qa.coleccionista@cromos.test'
      )
      ORDER BY copied_at DESC
      LIMIT 1
    )
    AND ts.global_number = 45;
    ```
    **Instrucciones para ejecutar la consulta:**
    1. En Supabase Dashboard, ir a **SQL Editor**.
    2. Copiar y pegar la consulta anterior.
    3. Reemplazar el número 45 si se prueba con otro valor.
    4. Hacer clic en **"Run"**.
    5. Verificar que devuelve el slot 45 con su variante (si existe) y página asociada.

    **Resultado esperado:** La consulta debe devolver el slot solicitado con todos sus datos de referencia.

  Verificación en Chrome (consola):
    **Verificación en Chrome (consola):**
    1. Con la modal de entrada rápida abierta, hacer clic derecho y seleccionar **Inspeccionar**.
    2. Ir a la pestaña **Console**.
    3. Escribir "45" en el campo y presionar Enter.
    4. Verificar que no aparecen errores en la consola y que la UI responde correctamente.
    5. Repetir con "999" y confirmar que aparece mensaje de error claro.

    **Si hay errores:**
    1. Capturar cualquier error 500 o timeout
    2. Verificar que el manejo de errores es amigable para el usuario

    Para más ayuda sobre cómo ejecutar consultas SQL, ver: GUIA_DE_CONSULTAS_SQL.md
    Para más ayuda sobre cómo usar la consola de Chrome, ver: GUIA_DE_CONSOLA_CHROME.md

Caso CP-F02-02B3: Completar toda la página (Bulk Completion)
  Cobertura: Actualización masiva; confirmaciones; preservación de datos existentes.
  Pasos:
    1. En una página con cromos mixtos (algunos Tengo, otros Necesito).
    2. Pulsar botón "Completar toda la página".
    3. Leer modal de confirmación y pulsar "Confirmar".
    4. Verificar que todos los cromos cambian a "Tengo".
    5. Repetir operación en otra página para verificar que solo afecta a la página actual.
  Criterios de éxito:
    - Modal explica claramente qué cromos se modificarán.
    - Botón "Cancelar" cierra modal sin cambios.
    - Solo cromos "Necesito" cambian a "Tengo" (los "Tengo" existentes se preservan).
    - Operación se completa en <2 segundos para página con ~50 cromos.
    - Badges de página se actualizan correctamente.

  Validación en Supabase (SQL):
    ```sql
    -- Consulta para verificar la actualización masiva
    SELECT COUNT(*) AS total_actualizados,
           SUM(CASE WHEN status = 'Tengo' THEN 1 ELSE 0 END) AS ahora_tengo,
           SUM(CASE WHEN status = 'Necesito' THEN 1 ELSE 0 END) AS ahora_necesito
    FROM user_template_progress
    WHERE copy_id = (
      SELECT id FROM user_template_copies
      WHERE user_id = (
        SELECT id FROM auth.users 
        WHERE email = 'qa.coleccionista@cromos.test'
      )
      ORDER BY copied_at DESC
      LIMIT 1
    )
    AND page_id = (
      SELECT id FROM template_pages
      WHERE template_id = (
        SELECT template_id FROM user_template_copies
        WHERE user_id = (
          SELECT id FROM auth.users 
          WHERE email = 'qa.coleccionista@cromos.test'
        )
        ORDER BY copied_at DESC
        LIMIT 1
      )
      AND page_number = [NUMERO_DE_PAGINA_A_PROBAR]
    );
    ```
    **Instrucciones para ejecutar la consulta:**
    1. En Supabase Dashboard, ir a **SQL Editor**.
    2. Copiar y pegar la consulta anterior.
    3. Reemplazar `[NUMERO_DE_PAGINA_A_PROBAR]` con el número de página que se está probando.
    4. Hacer clic en **"Run"**.
    5. Verificar que `ahora_tengo` aumenta y `ahora_necesito` disminuye tras la operación.

    **Resultado esperado:** La consulta debe mostrar el aumento de cromos "Tengo" y la disminución de cromos "Necesito".

  Verificación en Chrome (consola):
    **Verificación en Chrome (consola):**
    1. Antes de pulsar "Completar toda la página", abrir la consola como se indicó anteriormente.
    2. Pulsar el botón y observar que se envía una petición de actualización masiva.
    3. Tras completar, verificar que no aparecen errores y que la UI refleja los cambios correctamente.
    4. Verificar que los contadores en la página se actualizan inmediatamente.

    **Si hay errores:**
    1. Buscar cualquier error de red o timeout en la consola
    2. Verificar que la operación completa aunque si hay errores menores de UI

    Para más ayuda sobre cómo ejecutar consultas SQL, ver: GUIA_DE_CONSULTAS_SQL.md
    Para más ayuda sobre cómo usar la consola de Chrome, ver: GUIA_DE_CONSOLA_CHROME.md

Caso CP-F02-02C: Gestión de duplicados y decrementos
  Cobertura: Edge cases; límites 0; sincronización con marketplace.
  Pasos:
    1. En una página con un cromo marcado como "Repetido" (count = 3).
    2. Pulsar "Marcar como vendido" y confirmar.
    3. Verificar que el contador disminuye a 2 y el cromo cambia a "Tengo".
    4. Intentar marcar como vendido nuevamente (count = 2).
    5. Publicar ese cromo como duplicado en marketplace.
    6. Verificar que el contador vuelve a 1 y aparece badge de sincronización.
    7. Forzar contador a 0 marcando todos como vendidos.
    8. Verificar que botón "Marcar como vendido" se deshabilita.
    9. Verificar que aparece mensaje "Sin duplicados disponibles".
    Criterios de éxito:
    - Decremento funciona correctamente al marcar como vendido.
    - Publicación como duplicado decrementa el contador automáticamente.
    - Sistema previene acciones inválidas cuando no hay duplicados.
    - Mensajes de error y advertencia son claros y en español.

  Validación en Supabase (SQL):
    ```sql
    -- Consulta para verificar el estado del contador después de operaciones
    SELECT utp.status,
           utp.count,
           utp.updated_at
    FROM user_template_progress utp
    WHERE utp.copy_id = (
      SELECT id FROM user_template_copies
      WHERE user_id = (
        SELECT id FROM auth.users 
        WHERE email = 'qa.coleccionista@cromos.test'
      )
      ORDER BY copied_at DESC
      LIMIT 1
    )
    AND utp.slot_id = (
      SELECT id FROM template_slots
      WHERE template_id = (
        SELECT template_id FROM user_template_copies
        WHERE user_id = (
          SELECT id FROM auth.users 
          WHERE email = 'qa.coleccionista@cromos.test'
        )
        ORDER BY copied_at DESC
          LIMIT 1
      )
      AND slot_number = [NUMERO_DE_SLOT_A_PROBAR]
    );
    ```
    **Instrucciones para ejecutar la consulta:**
    1. En Supabase Dashboard, ir a **SQL Editor**.
    2. Copiar y pegar la consulta anterior.
    3. Reemplazar `[NUMERO_DE_SLOT_A_PROBAR]` con el número del slot que se está probando.
    4. Ejecutar la consulta antes y después de cada operación para verificar el estado.

    **Resultado esperado:** El `count` debe disminuir correctamente al marcar como vendido y aumentar al publicar como duplicado.

  Verificación en Chrome (consola):
    **Verificación en Chrome (consola):**
    1. Con la vista de colección abierta, abrir la consola como se indicó anteriormente.
    2. Realizar cada operación (marcar como vendido, publicar duplicado) y observar las peticiones en la pestaña Network.
    3. Verificar que las peticiones se completan con código 200 y no hay errores en la consola.
    4. Tras forzar el contador a 0, intentar marcar como vendido y verificar que aparece mensaje de error.

    **Si hay errores:**
    1. Buscar errores 400/500 en la pestaña Network
    2. Verificar que los mensajes de error en la consola son claros y útiles

    Para más ayuda sobre cómo ejecutar consultas SQL, ver: GUIA_DE_CONSULTAS_SQL.md
    Para más ayuda sobre cómo usar la consola de Chrome, ver: GUIA_DE_CONSOLA_CHROME.md

Notas generales:
- Registrar en la planilla QA los IDs de copias (`copy_id`) para usar en pruebas de integración (Fase 04).
- Documentar cualquier desfase (>2 s) entre acciones de UI y actualización de contadores.
- Para todas las consultas, utilizar Supabase Dashboard → SQL Editor y actualizar los placeholders antes de ejecutar.
