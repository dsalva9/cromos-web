Nombre del conjunto: CP-F02-02 Copias, progreso y valoraciones de plantillas
Fase: 02 - Plantillas y Colecciones
Objetivo: Asegurar que los usuarios puedan copiar plantillas públicas, gestionar el progreso de cada slot, mantener el conteo de duplicados y emitir valoraciones sin violar restricciones de autoría.

Pre-requisitos generales:
- Plantilla pública “Colección QA Liga 2025” creada en CP-F02-01C.
- Usuario coleccionista: `qa.coleccionista@cromos.test` (sin copias previas).
- Usuario autor original para verificar restricciones.
- Acceso a tablas `user_template_copies`, `user_template_progress`, `template_ratings`.
- Herramientas: Chrome desktop, Safari/Chrome móvil, planilla para seguimiento de conteos.

Configuración previa:
- Borrar registros previos en `user_template_copies` del usuario coleccionista si existen.
- Verificar que la plantilla esté visible públicamente (`is_public = true`, `is_deleted = false`).
- Preparar datos de ejemplo para duplicados (p.ej. 3 cromos repetidos).

Casos de prueba:

Caso CP-F02-02A: Copiar plantilla pública
  Cobertura: Happy path; inicialización de progreso.
  Pasos:
    1. Iniciar sesión con `qa.coleccionista`.
    2. Abrir `/templates/{id}` y pulsar “Copiar plantilla”.
    3. Asignar nombre a la copia y confirmar.
    4. Navegar a `/mi-coleccion`.
  Criterios de éxito:
    - Se crea registro en `user_template_copies` con `title` personalizado y `copied_at`.
    - Página de colección muestra pestañas por páginas con totales Have/Need/Dupes = 0.
    - Toast confirma creación y redirige a vista de progreso.

Caso CP-F02-02B: Actualizar progreso de slots (HAVE/NEED/DUPES)
  Cobertura: Interacciones; cálculos agregados.
  Pasos:
    1. En la copia, marcar slots 1-3 como "Tengo".
    2. Marcar slot 4 como "Repetido" con cantidad 2.
    3. Marcar slot 5 como "Necesito".
    4. Revisar contador global y barra de progreso.
  Criterios de éxito:
    - `user_template_progress` almacena registros con `status` correcto y `count`.
    - Panel resumen actualiza porcentajes en tiempo real (sin recarga).
    - Slots marcados muestran iconografía adecuada (color verde, dorado, rojo).
    - Valores persisten tras recargar y en móvil.

Caso CP-F02-02B2: Entrada rápida por número de checklist (Quick Entry) - ACTUALIZADO 2025-11-04
  Cobertura: Modalidad de entrada rápida simplificada; navegación por teclado; mapeo automático.
  Pre-requisito: Copia de plantilla con números globales asignados (ver CP-F02-01A2).
  Pasos:
    1. En vista de progreso de copia, pulsar botón "Entrada Rápida" o similar.
    2. **ACTUALIZADO**: Modal abre directamente en modo "Por Número" (sin pestañas).
    3. Verificar que el título del modal incluya ícono de hash y "Entrada Rápida por Número".
    4. Escribir "45" y presionar Enter.
    5. Escribir "46" y presionar Enter.
    6. Escribir "999" (número inexistente) y presionar Enter.
    7. Verificar log de "Últimas actualizaciones" (máximo 5 entradas).
    8. Verificar "Referencia de Números" mostrando primeros 20 cromos con estado.
  Criterios de éxito:
    - Modal abre con foco automático en campo de entrada (sin necesidad de clic).
    - **ACTUALIZADO**: No hay pestañas ni selector de páginas (modo único).
    - Al ingresar "45", sistema localiza slot 5A y lo marca como "Tengo" sin salir del modal.
    - Mensaje de confirmación muestra: "✓ No. 45 - Gorosabel (Athletic Club, Slot 5A)".
    - Al ingresar "999", muestra "❌ No. 999 no encontrado".
    - Campo se limpia automáticamente tras cada entrada y mantiene el foco.
    - Lista de referencia actualiza badges en tiempo real (Falta/Tengo/Duplicado).
    - Progreso se actualiza en la vista principal sin cerrar modal.
    - **ELIMINADO**: Modo "Por Página" ya no existe (funcionalidad redundante con grid principal).

Caso CP-F02-02B3: Completar toda la página (Bulk Completion) - NUEVO 2025-11-04
  Cobertura: Actualización masiva; confirmación de operaciones peligrosas; preservación selectiva.
  Pre-requisito: Copia con página parcialmente completada (algunos "Falta", algunos "Tengo", algunos "Repes").
  Pasos:
    1. Navegar a página con estado mixto (ej: 10 cromos Falta, 5 Tengo, 3 Repes).
    2. Desplazarse al final del grid de cromos.
    3. Pulsar botón "Completar toda la página" (outline amarillo, icono CheckCircle2).
    4. Leer modal de confirmación: "¿Quieres marcar toda la página como completada?".
    5. Verificar mensaje explicativo sobre preservación de cromos existentes.
    6. Pulsar "Confirmar".
    7. Observar estado de loading en botón ("Completando...").
    8. Tras cierre de modal, verificar estado de todos los cromos en grid.
    9. Repetir proceso en página diferente.
  Criterios de éxito:
    - Botón visible y centrado debajo del grid en todas las páginas.
    - Modal explica claramente: "Los cromos que ya tengas (Tengo o Repes) no se modificarán".
    - Solo los cromos marcados como "Falta" (count 0, badge gris) cambian a "Tengo" (count 1, badge verde).
    - Cromos previamente "Tengo" (count 1) se mantienen sin cambios.
    - Cromos "Repes" (count > 1, badge azul) mantienen su contador exacto.
    - Botón "Cancelar" cierra modal sin realizar cambios.
    - Operación completa en <2 segundos para página de ~50 cromos.
    - Grid actualiza badges inmediatamente sin recarga.
    - Contador de progreso global refleja nuevo estado.
    - Operación en página 1 no afecta estado de página 2.

Caso CP-F02-02C: Gestión de duplicados y decrementos
  Cobertura: Edge; límites 0; sincronización con marketplace (pre-integration).
  Pasos:
    1. Incrementar duplicados hasta 5 y decrementar hasta 0.
    2. Validar que el botón “Publicar duplicado” aparece solo con count > 0.
    3. Intentar poner valores negativos (teclado manual).
  Criterios de éxito:
    - Botón “-” deshabilitado cuando count = 0.
    - Intento de introducir valor negativo se corrige a 0.
    - Contador global de duplicados se actualiza con badges correspondientes.

Caso CP-F02-02D: Filtrado y búsqueda dentro de la copia
  Cobertura: Herramientas de navegación; UX.
  Pasos:
    1. Usar campo de búsqueda para encontrar slot “3”.
    2. Aplicar filtro “Mostrar solo Necesito”.
    3. Verificar funcionamiento en móvil (375px) y tablet (768px).
  Criterios de éxito:
    - Lista se filtra correctamente, mostrando mensajes de “sin resultados” cuando corresponde.
    - Filtros combinados (búsqueda + estado) funcionan sin recargar.
    - En móvil, los filtros se muestran en sheet/modal sin cortar texto.

Caso CP-F02-02E: Restricciones de visibilidad y borrado de plantilla origen
  Cobertura: Edge; resiliencia.
  Pasos:
    1. Con el autor, marcar la plantilla original como privada o eliminarla (ver CP-F02-01F).
    2. Desde la copia, recargar la página.
  Criterios de éxito:
    - Se muestra aviso en la copia “Plantilla original no disponible”, pero progreso sigue accesible.
    - No se borran registros de progreso.
    - Botón “Ver plantilla original” desaparece o muestra mensaje predecible.

Caso CP-F02-02F: Valoraciones de plantilla (usuario no autor)
  Cobertura: Flujo completo rating; límites; localización.
  Pasos:
    1. Con `qa.coleccionista`, en la página pública de la plantilla, pulsar “Valorar plantilla”.
    2. Asignar 4 estrellas y comentario de 120 caracteres.
    3. Guardar y verificar actualización del promedio.
    4. Editar la valoración a 5 estrellas con comentario distinto.
    5. Eliminar valoración.
  Criterios de éxito:
    - Modal obliga a seleccionar al menos 1 estrella; contador de caracteres en vivo.
    - Tras guardar, `template_ratings` contiene registro con `rating = 4` y `comment`.
    - `TemplateRatingSummary` actualiza distribución y resalta la valoración del usuario.
    - Botón “Eliminar valoración” solicita confirmación y limpia el registro.

Caso CP-F02-02G: Restricciones de valoración
  Cobertura: Edge; autor y usuarios no autenticados.
  Pasos:
    1. Autor intenta abrir modal de valoración en su propia plantilla.
    2. Usuario no autenticado hace clic en “Valorar”.
    3. Usuario autenticaso intenta escribir comentario >280 caracteres.
  Criterios de éxito:
    - Autor ve mensaje “No puedes valorar tu propia plantilla”.
    - Usuario sin sesión es redirigido a login con redirect guardado.
    - Comentarios >280 se bloquean con contador rojo y botón deshabilitado.

Caso CP-F02-02H: Efectos en listados de plantillas
  Cobertura: Refresco de métricas.
  Pasos:
    1. Tras varias valoraciones de diferentes usuarios, revisar `/templates`.
    2. Confirmar que la tarjeta muestra rating promedio y cantidad de reseñas.
  Criterios de éxito:
    - Los datos concuerdan con agregados `rating_avg` y `rating_count`.
    - En mobile, la tarjeta proyecta estrellas legibles.

Caso CP-F02-02I: Eliminar colección rastreada - NUEVO 2025-11-04
  Cobertura: Gestión de copias; eliminación segura; confirmación de operaciones destructivas.
  Pre-requisito: Usuario con al menos una copia de plantilla con progreso registrado y anuncios publicados en el marketplace.
  Pasos:
    1. Iniciar sesión con usuario que tenga copias de plantillas.
    2. Navegar a `/mis-plantillas` y seleccionar una colección con progreso.
    3. En la vista de progreso `/mis-plantillas/[copyId]`, localizar botón "Eliminar colección" (variante destructiva, ícono papelera).
    4. Pulsar botón "Eliminar colección".
    5. Leer modal de confirmación con título "¿Eliminar colección?".
    6. Verificar mensaje explicativo sobre consecuencias:
       - "Esta acción no se puede deshacer"
       - "Perderás todo el progreso registrado para esta colección"
       - "Los anuncios en el mercado no se verán afectados"
    7. Pulsar "Cancelar" y verificar que modal se cierra sin cambios.
    8. Volver a abrir modal y pulsar "Eliminar".
    9. Observar estado de loading en botón ("Eliminando...").
    10. Tras eliminación exitosa, verificar redirección automática a `/mis-plantillas`.
    11. Confirmar que la colección eliminada ya no aparece en el listado.
    12. Verificar en marketplace que anuncios publicados desde esa copia siguen activos.
    13. Intentar acceder directamente a URL `/mis-plantillas/[copyId]` de copia eliminada.
  Criterios de éxito:
    - Botón "Eliminar colección" visible en header de vista de progreso (junto a "Entrada Rápida" si aplica).
    - Modal de confirmación muestra advertencia clara en español sobre pérdida irreversible de progreso.
    - Botón "Cancelar" cierra modal sin realizar cambios (colección permanece).
    - Al confirmar eliminación, RPC `delete_template_copy` se ejecuta correctamente.
    - Toast de éxito: "Colección eliminada correctamente".
    - Redirección automática a `/mis-plantillas` tras eliminación.
    - Colección eliminada desaparece del listado en `/mis-plantillas`.
    - Registros eliminados en `user_template_copies` y `user_template_progress` (cascade).
    - Anuncios en `trade_listings` publicados desde esa copia permanecen activos e intactos.
    - Acceso directo a URL de copia eliminada muestra "Colección no encontrada" con botón de retorno.
    - En caso de error durante eliminación, toast muestra "Error al eliminar la colección".
    - Operación completa en <1 segundo para colecciones con progreso extenso.
    - Funcionalidad responsive en mobile (botón y modal legibles).

Notas generales:
- Registrar IDs de copias (`copy_id`) para usarlos en pruebas de integración (Fase 04).
- Si se usan usuarios adicionales para valoraciones, anotar credenciales empleadas.
- Al probar eliminación de colecciones, verificar que los `copy_id` asociados a listings en marketplace no se corrompen.
