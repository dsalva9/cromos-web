Nombre del conjunto: CP-F02-01 Creación y edición de plantillas
Fase: 02 - Plantillas y Colecciones
Objetivo: Validar que los autores puedan crear, publicar y actualizar plantillas de colecciones cumpliendo reglas de negocio, restricciones de base de datos y estilo Retro-Comic.

Pre-requisitos generales:
- Usuario autor: `qa.creador@cromos.test` (sin plantillas publicadas).
- Usuario observador: `qa.observador@cromos.test` para confirmar visibilidad pública.
- Plantilla de referencia “Álbum Mundial 2022 QA” (ID `tmpl_ref_001`) disponible para comparaciones.
- Acceso a Supabase Dashboard (`https://app.supabase.com`) con permisos de lectura en Auth, Storage y SQL.
- Herramientas: Chrome desktop, Chrome DevTools en 768 px (tablet) y 375 px (móvil), planilla para registrar IDs generados.

Configuración previa:
- Eliminar borradores previos del autor (`collection_templates.is_public = FALSE`) antes de iniciar.
- Tener a mano URLs de portada válidas e inválidas para pruebas de validación.

Casos de prueba:

Caso CP-F02-01A: Crear plantilla privada con páginas y slots
  Cobertura: Flujo feliz; guardado incremental; estructura básica.
  Pasos:
    1. Iniciar sesión con `qa.creador@cromos.test`.
    2. Navegar a `/templates/new` y completar título “Colección QA Liga 2025”, descripción >120 caracteres y portada opcional.
    3. Agregar dos páginas:
       - Página 1 “Equipo A” con 9 slots numerados 1-9.
       - Página 2 “Equipo B” con 6 slots; marcar slot 6 como especial.
    4. Guardar como borrador (sin publicar).
  Validaciones UI:
    - Botón “Guardar borrador” solo se habilita con campos obligatorios completos.
    - Toast “Plantilla guardada como borrador”.
    - Resumen lateral muestra conteo correcto de páginas y slots.
  Validación en Supabase (SQL):
    ```sql
    SELECT title,
           is_public,
           is_deleted,
           pages_count,
           slots_count
    FROM collection_templates
    WHERE title = 'Colección QA Liga 2025';
    ```
    ```sql
    SELECT tp.page_name,
           ts.slot_number,
           ts.is_special
    FROM template_pages tp
    JOIN template_slots ts ON ts.page_id = tp.id
    WHERE tp.template_id = (
      SELECT id FROM collection_templates
      WHERE title = 'Colección QA Liga 2025'
      ORDER BY created_at DESC
      LIMIT 1
    )
    ORDER BY tp.page_order, ts.slot_number;
    ```
  Instrucciones para ejecutar las consultas:
    - Abrir Supabase → **SQL Editor**, ejecutar ambas consultas y confirmar que `is_public = false`, `pages_count = 2`, `slots_count = 15` y que el slot 6 aparece como `is_special = true`.
  Verificación en Chrome (consola):
    1. Haz clic derecho en la vista de edición y selecciona **Inspeccionar**.
    2. Ve a la pestaña **Console** antes de guardar.
    3. Guarda el borrador y comprueba que no se registran errores en rojo.

Caso CP-F02-01A2: Crear plantilla con variantes y numeración global estilo Panini
  Cobertura: Variantes de slots; numeración global y por página; publicación.
  Pasos:
    1. Iniciar sesión con `qa.creador`.
    2. Completar el asistente `/templates/create` con título “Álbum LaLiga QA 2025-26”.
    3. En “Páginas y Cromos”, añadir página “Athletic Club”:
       - Slot 1: global 1, página 1, sin variante, nombre “Sivera”.
       - Slot 2 y 3: ajustar a global 1 y 2 con variantes A/B, página 5, nombre “Gorosabel” / “Lekue”.
       - Slot 4: global 4, página 9, variante A.
    4. Añadir segunda página “Real Madrid” y confirmar que comienza en global 5.
    5. Completar revisión y publicar.
  Validaciones UI:
    - Popup de ayuda (ícono ℹ) explica numeración global/página/variante.
    - La vista previa lista slots como “3. Sivera”, “5A. Gorosabel”, “5B. Lekue”, “9A. Yuri”.
    - Toast “Plantilla publicada” al finalizar.
  Validación en Supabase (SQL):
    ```sql
    SELECT title,
           is_public,
           rating_count,
           copies_count
    FROM collection_templates
    WHERE title = 'Álbum LaLiga QA 2025-26'
    ORDER BY created_at DESC
    LIMIT 1;
    ```
    ```sql
    SELECT ts.slot_number,
           ts.global_number,
           ts.slot_variant,
           ts.is_special
    FROM template_slots ts
    WHERE ts.template_id = (
      SELECT id FROM collection_templates
      WHERE title = 'Álbum LaLiga QA 2025-26'
      ORDER BY created_at DESC
      LIMIT 1
    )
    ORDER BY ts.global_number, ts.slot_variant NULLS FIRST;
    ```
  Instrucciones:
    - Ejecutar las consultas y confirmar que `is_public = true`, `global_number` es secuencial y `slot_variant` contiene ‘A’/‘B’ cuando se configuró.
  Verificación en Chrome:
    1. Abrir **Inspeccionar**.
    2. En la pestaña **Console**, publicar y asegurarse de que no se muestran errores.
    3. Revisar **Network** filtrando por `/rest/v1/template_slots` para comprobar respuestas 200.

Caso CP-F02-01B: Validaciones de formulario y duplicados
  Cobertura: Mensajes de error; validación cliente/servidor.
  Pasos:
    1. Intentar guardar con título vacío y descripción <30 caracteres.
    2. Crear dos slots con el mismo número y variante.
    3. Guardar y observar la respuesta.
  Validaciones UI:
    - Aparecen mensajes “Campo obligatorio” y bordes rojos.
    - Al duplicar slot, se marca “Duplicado” y se bloquea el guardado.
  Validación en Supabase (SQL):
    ```sql
    SELECT COUNT(*) AS slots_duplicados
    FROM template_slots
    WHERE template_id = (
      SELECT id FROM collection_templates
      WHERE title = 'Colección QA Liga 2025'
      ORDER BY created_at DESC
      LIMIT 1
    )
    GROUP BY template_id, slot_number, COALESCE(slot_variant, '')
    HAVING COUNT(*) > 1;
    ```
  Instrucciones:
    - Ejecutar después de intentar guardar; el resultado debe estar vacío.
  Verificación en Chrome:
    1. Abrir **Console** antes de forzar los errores.
    2. Confirmar que solo aparecen warnings controlados, sin stack traces.

Caso CP-F02-01C: Publicar plantilla y visibilidad pública
  Cobertura: Cambios de estado; visibilidad para terceros.
  Pasos:
    1. Publicar el borrador “Colección QA Liga 2025”.
    2. Abrir la URL pública con `qa.observador`.
  Validaciones UI:
    - La ficha muestra badge “Pública” y aparece en listados `/templates`.
    - El observador puede ver descripción, portada y slots.
  Validación en Supabase (SQL):
    ```sql
    SELECT title,
           is_public,
           published_at
    FROM collection_templates
    WHERE title = 'Colección QA Liga 2025'
    ORDER BY updated_at DESC
    LIMIT 1;
    ```
  Instrucciones:
    - Confirmar que `is_public = true` y `published_at` no es nulo.
  Verificación en Chrome:
    1. Con la plantilla publicada, abrir **Inspeccionar**.
    2. En **Console**, navegar con `qa.observador` y comprobar que no aparecen errores.

Caso CP-F02-01D: Edición de metadatos publicados
  Cobertura: Control de cambios; auditoría.
  Pasos:
    1. Con plantilla publicada, editar título y descripción.
    2. Guardar y revisar historial.
  Validaciones UI:
    - Toast “Plantilla actualizada”.
    - Vista pública refleja los nuevos metadatos tras recargar.
  Validación en Supabase (SQL):
    ```sql
    SELECT title,
           description,
           updated_at
    FROM collection_templates
    WHERE title LIKE 'Colección QA Liga 2025%'
    ORDER BY updated_at DESC
    LIMIT 1;
    ```
    ```sql
    SELECT action,
           metadata->>'template_id' AS template_id,
           created_at
    FROM audit_log
    WHERE action = 'template_visibility_change'
    ORDER BY created_at DESC
    LIMIT 1;
    ```
  Instrucciones:
    - Verificar que `updated_at` coincide con la edición y que se registra en `audit_log`.
  Verificación en Chrome:
    1. Abrir **Console** antes de guardar cambios.
    2. Confirmar que no aparecen errores tras publicar la edición.

Caso CP-F02-01E: Edición completa con nuevos campos
  Cobertura: Eliminación y reorden de páginas/slots; integridad referencial.
  Pasos:
    1. Editar la plantilla publicada y:
       - Reordenar páginas.
       - Eliminar un slot y agregar uno nuevo.
       - Cambiar el tipo “especial”.
    2. Guardar y revisar vista previa.
  Validaciones UI:
    - La numeración se recalcula correctamente.
    - No se muestran slots “huérfanos”.
  Validación en Supabase (SQL):
    ```sql
    SELECT tp.page_name,
           tp.page_order,
           ts.slot_number,
           ts.is_special
    FROM template_pages tp
    JOIN template_slots ts ON ts.page_id = tp.id
    WHERE tp.template_id = (
      SELECT id FROM collection_templates
      WHERE title LIKE 'Colección QA Liga 2025%'
      ORDER BY updated_at DESC
      LIMIT 1
    )
    ORDER BY tp.page_order, ts.slot_number;
    ```
  Instrucciones:
    - Confirmar que la ordenación coincide con la UI y que el slot eliminado ya no aparece.
  Verificación en Chrome:
    1. Abrir **Inspeccionar** → **Console**.
    2. Guardar cambios y verificar que no surgen errores o peticiones fallidas en **Network**.

Caso CP-F02-01F: Eliminación total de plantilla
  Cobertura: Soft delete; limpieza de contenido relacionado.
  Pasos:
    1. Desde la vista de edición, seleccionar “Eliminar plantilla” y confirmar.
    2. Revisar la lista de plantillas del autor.
  Validaciones UI:
    - Toast “Plantilla eliminada”.
    - Ya no aparece en `/templates` ni en el listado del autor.
  Validación en Supabase (SQL):
    ```sql
    SELECT title,
           is_deleted,
           deleted_at
    FROM collection_templates
    WHERE title LIKE 'Colección QA Liga 2025%'
    ORDER BY deleted_at DESC
    LIMIT 1;
    ```
  Instrucciones:
    - Confirmar que `is_deleted = true` y `deleted_at` tiene timestamp.
  Verificación en Chrome:
    1. Abrir **Console** antes de eliminar.
    2. Confirmar que la petición DELETE responde 200 en **Network** y no hay errores en consola.

Caso CP-F02-01G: Restricciones de autoría
  Cobertura: RLS; acceso controlado.
  Pasos:
    1. Con `qa.observador`, intentar editar la plantilla.
    2. Observar respuesta y mensajes.
  Validaciones UI:
    - Se bloquea la edición y se muestra mensaje “No tienes permisos”.
  Validación en Supabase (SQL):
    ```sql
    SELECT policyname,
           cmd,
           roles
    FROM pg_policies
    WHERE tablename = 'collection_templates';
    ```
  Instrucciones:
    - Ejecutar para confirmar existencia de política `Authors can update own templates`.
  Verificación en Chrome:
    1. Con `qa.observador`, abrir **Console**.
    2. Intentar editar y asegurar que la respuesta HTTP es 403 sin errores adicionales.

Caso CP-F02-01H: Sistema de valoraciones de plantillas
  Cobertura: Rating promedio; conteo de votos.
  Pasos:
    1. Con `qa.observador`, puntuar la plantilla con 4 estrellas.
    2. Cambiar a `qa.creador` y revisar resumen.
  Validaciones UI:
    - Rating promedio y conteo se actualizan en tiempo real.
  Validación en Supabase (SQL):
    ```sql
    SELECT rating_avg,
           rating_count
    FROM collection_templates
    WHERE title LIKE 'Álbum LaLiga QA 2025-26%'
    ORDER BY updated_at DESC
    LIMIT 1;
    ```
    ```sql
    SELECT rating,
           created_by
    FROM template_ratings
    WHERE template_id = (
      SELECT id FROM collection_templates
      WHERE title LIKE 'Álbum LaLiga QA 2025-26%'
      ORDER BY updated_at DESC
      LIMIT 1
    )
    ORDER BY created_at DESC
    LIMIT 3;
    ```
  Instrucciones:
    - Confirmar que `rating_count` incrementa y el registro corresponde al usuario evaluador.
  Verificación en Chrome:
    1. Abrir **Console** en la vista pública.
    2. Puntuar y verificar ausencia de errores.

Caso CP-F02-01I: Compatibilidad retroactiva con plantillas existentes
  Cobertura: Migraciones de schema; manejo de NULL en nuevas columnas.
  Pasos:
    1. Abrir la plantilla de referencia “Álbum Mundial 2022 QA”.
    2. Revisar slots existentes para confirmar que se muestran sin variantes.
  Validaciones UI:
    - Los slots antiguos se renderizan sin errores ni valores vacíos inesperados.
  Validación en Supabase (SQL):
    ```sql
    SELECT slot_variant,
           global_number
    FROM template_slots
    WHERE template_id = 'tmpl_ref_001'
    LIMIT 5;
    ```
  Instrucciones:
    - Confirmar que `slot_variant` puede ser NULL y que `global_number` tiene valores consistentes.
  Verificación en Chrome:
    1. Abrir **Console** en la vista de la plantilla.
    2. Navegar por las páginas y comprobar que no se generan errores.

Notas generales:
- Registrar en la planilla QA los IDs de plantillas creadas, páginas y slots para limpieza posterior.
- Para todas las consultas, utilizar Supabase Dashboard → SQL Editor; reemplazar títulos o IDs cuando sea necesario.
- Conservar capturas de pantalla y tiempos de ejecución en la carpeta compartida QA.
