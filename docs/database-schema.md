# Database Schema Documentation

## Current State: v1.3.0 (All features deployed)

Last updated: 2025-01-XX
Source: Direct export from Supabase production database

## Overview

The CambioCromos database consists of 13 tables supporting:

- User authentication and profiles
- Multi-collection sticker management
- Album-style page navigation (v1.3.0)
- Complete trading proposal system
- Trade history and chat
- User badges and achievements

---

## Core Tables

### `profiles`

User profiles extending Supabase Auth.

```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  nickname TEXT,
  avatar_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Indexes:**

- Primary key on `id`

**RLS Policies:**

- Users can read all profiles
- Users can only update their own profile

---

### `collections`

Sticker collections (e.g., "UEFA Euro 2024", "Liga 2024/25").

```sql
CREATE TABLE collections (
  id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  name TEXT NOT NULL,
  competition TEXT NOT NULL,
  year TEXT NOT NULL,
  description TEXT,
  image_url TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Indexes:**

- Primary key on `id`
- `idx_collections_active` on `(is_active)`

**RLS Policies:**

- Public read access
- Admin-only write access

---

### `collection_teams`

Teams within each collection.

```sql
CREATE TABLE collection_teams (
  id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  collection_id INTEGER REFERENCES collections(id) ON DELETE CASCADE,
  team_name TEXT NOT NULL,
  team_code TEXT,
  logo_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Indexes:**

- Primary key on `id`
- `idx_collection_teams_collection` on `(collection_id)`
- `idx_collection_teams_name` on `(team_name)` for trading queries

**RLS Policies:**

- Public read access
- Admin-only write access

---

### `stickers`

Individual stickers within collections.

```sql
CREATE TABLE stickers (
  id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  collection_id INTEGER REFERENCES collections(id) ON DELETE CASCADE,
  team_id INTEGER REFERENCES collection_teams(id) ON DELETE SET NULL,
  code TEXT NOT NULL,
  player_name TEXT NOT NULL,
  position TEXT,
  nationality TEXT,
  rating INTEGER,
  rarity TEXT CHECK (rarity IN ('common', 'rare', 'epic', 'legendary')),
  image_url TEXT,
  sticker_number INTEGER,
  image_path_webp_300 TEXT,
  thumb_path_webp_100 TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT unique_sticker_code UNIQUE (collection_id, code)
);
```

**New in v1.3.0:**

- `sticker_number`: Unique sequential number within collection
- `image_path_webp_300`: Path to full-size WebP image in Supabase Storage
- `thumb_path_webp_100`: Path to 100px thumbnail in Supabase Storage

**Indexes:**

- Primary key on `id`
- `idx_stickers_collection` on `(collection_id)`
- `idx_stickers_collection_filters` on `(collection_id, rarity, team_id, player_name)` for trading
- `idx_stickers_collection_number_unique` (partial) on `(collection_id, sticker_number)` WHERE `sticker_number IS NOT NULL`

**RLS Policies:**

- Public read access
- Admin-only write access

---

### `user_collections`

Tracks which collections users have joined and which is active.

```sql
CREATE TABLE user_collections (
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  collection_id INTEGER REFERENCES collections(id) ON DELETE CASCADE,
  is_active BOOLEAN DEFAULT false,
  joined_at TIMESTAMPTZ DEFAULT NOW(),

  PRIMARY KEY (user_id, collection_id),
  CONSTRAINT unique_active_per_user
    UNIQUE (user_id, is_active)
    WHERE (is_active = true)
);
```

**Constraints:**

- Only one active collection per user (partial unique constraint)

**Indexes:**

- Primary key on `(user_id, collection_id)`

**RLS Policies:**

- Users can only access their own collection memberships

---

### `user_stickers`

User's sticker inventory.

```sql
CREATE TABLE user_stickers (
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  sticker_id INTEGER REFERENCES stickers(id) ON DELETE CASCADE,
  count INTEGER NOT NULL DEFAULT 0,
  wanted BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  PRIMARY KEY (user_id, sticker_id)
);
```

**Indexes:**

- Primary key on `(user_id, sticker_id)`
- `idx_user_stickers_trading` on `(sticker_id, user_id, wanted, count)` for legacy compatibility
- `idx_user_stickers_trading_v2` on `(sticker_id, user_id, count)` for duplicate-driven trading queries

**RLS Policies:**

- Users can only access their own sticker inventory

**Notes:**

- The `wanted` column remains for backward compatibility. Supabase RPCs now infer trade intent from inventory counts (missing = `count = 0`, duplicates = `count > 1`), so application code should avoid mutating this flag.

---

## Album Pages System (v1.3.0)

### `collection_pages`

Defines pages within an album (team rosters, special cards sections).

```sql
CREATE TABLE collection_pages (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  collection_id INTEGER NOT NULL REFERENCES collections(id) ON DELETE CASCADE,
  kind TEXT NOT NULL CHECK (kind IN ('team', 'special')),
  team_id INTEGER REFERENCES collection_teams(id) ON DELETE SET NULL,
  title TEXT NOT NULL,
  order_index INTEGER NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  CONSTRAINT collection_pages_kind_team_check
    CHECK ((kind = 'team' AND team_id IS NOT NULL) OR
           (kind = 'special' AND team_id IS NULL))
);
```

**Design:**

- `kind = 'team'`: Team roster page (20 slots: badge, manager, 18 players)
- `kind = 'special'`: Special cards page (variable slots)
- `order_index`: Sort order for page navigation

**Indexes:**

- Primary key on `id`
- `idx_collection_pages_order` on `(collection_id, order_index)`

**RLS Policies:**

- Public read access
- No client writes allowed

---

### `page_slots`

Maps stickers to specific positions on album pages.

```sql
CREATE TABLE page_slots (
  page_id BIGINT NOT NULL REFERENCES collection_pages(id) ON DELETE CASCADE,
  slot_index INTEGER NOT NULL,
  sticker_id INTEGER REFERENCES stickers(id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  PRIMARY KEY (page_id, slot_index)
);
```

**Design:**

- `slot_index`: 0-based position on page
- For team pages: 0 = badge, 1 = manager, 2-19 = players
- For special pages: variable based on content

**Indexes:**

- Primary key on `(page_id, slot_index)`
- `idx_page_slots_page_slot` on `(page_id, slot_index)` (covering index)

**RLS Policies:**

- Public read access
- No client writes allowed

---

## Trading System

### `trade_proposals`

Trade proposals between users.

```sql
CREATE TABLE trade_proposals (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  collection_id INTEGER NOT NULL REFERENCES collections(id) ON DELETE CASCADE,
  from_user UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  to_user UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  status TEXT NOT NULL DEFAULT 'pending'
    CHECK (status IN ('pending', 'accepted', 'rejected', 'cancelled')),
  message TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**Status Flow:**

- `pending`: Awaiting recipient response
- `accepted`: Recipient accepted the trade
- `rejected`: Recipient rejected the trade
- `cancelled`: Sender cancelled before response

**Indexes:**

- Primary key on `id`
- `idx_trade_proposals_from_user` on `(from_user, status)`
- `idx_trade_proposals_to_user` on `(to_user, status)`
- `idx_trade_proposals_status` on `(status)`

**RLS Policies:**

- Users can only see proposals where they are sender or receiver
- No direct INSERT/UPDATE/DELETE (must use RPC functions)

---

### `trade_proposal_items`

Individual stickers in each proposal (offer or request).

```sql
CREATE TABLE trade_proposal_items (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  proposal_id BIGINT NOT NULL REFERENCES trade_proposals(id) ON DELETE CASCADE,
  sticker_id INTEGER NOT NULL REFERENCES stickers(id) ON DELETE CASCADE,
  count INTEGER NOT NULL CHECK (count > 0),
  direction TEXT NOT NULL CHECK (direction IN ('offer', 'request')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**Design:**

- `direction = 'offer'`: Stickers the sender is offering
- `direction = 'request'`: Stickers the sender is requesting

**Indexes:**

- Primary key on `id`
- `idx_trade_proposal_items_proposal` on `(proposal_id)`

**RLS Policies:**

- Access controlled through parent `trade_proposals` table

---

### `trade_chats`

Chat messages within trade proposals.

```sql
CREATE TABLE trade_chats (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  trade_id BIGINT NOT NULL REFERENCES trade_proposals(id) ON DELETE CASCADE,
  sender_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  message TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**Indexes:**

- Primary key on `id`
- `idx_trade_chats_trade_created_at` on `(trade_id, created_at)` for chronological loading

**RLS Policies:**

- Only proposal participants can read/write messages
- Messages are immutable once created

---

### `trades_history`

Terminal state tracking for completed/cancelled trades.

```sql
CREATE TABLE trades_history (
  trade_id BIGINT PRIMARY KEY REFERENCES trade_proposals(id) ON DELETE CASCADE,
  status TEXT NOT NULL CHECK (status IN ('completed', 'cancelled')),
  completed_at TIMESTAMPTZ,
  cancelled_at TIMESTAMPTZ,
  metadata JSONB NOT NULL DEFAULT '{}'::jsonb
);
```

**Design:**

- Single row per trade once it reaches terminal state
- `metadata`: Reserved for audit trails, ratings, etc.

**Indexes:**

- Primary key on `trade_id`

**RLS Policies:**

- Only proposal participants can read history

---

## Badges & Achievements (v1.3.0)

### `user_badges`

User achievement badges.

```sql
CREATE TABLE user_badges (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  badge_code TEXT NOT NULL,
  awarded_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  CONSTRAINT user_badges_user_code_unique UNIQUE (user_id, badge_code)
);
```

**Design:**

- Service-managed (no direct client writes)
- `badge_code`: Unique identifier for badge type

**Indexes:**

- Primary key on `id`
- Unique constraint on `(user_id, badge_code)`

**RLS Policies:**

- Users can only read their own badges
- No client writes allowed

---

## Database Functions (RPCs)

### Collection Statistics

#### `get_user_collection_stats`

Returns completion statistics for a user's collection. Legacy clients can continue reading the `wanted` key, which now mirrors the new `missing` metric computed from ownership counts.

```sql
FUNCTION get_user_collection_stats(
  p_user_id UUID,
  p_collection_id INTEGER
) RETURNS JSON
```

**Returns:**

```json
{
  "total_stickers": 600,
  "owned_stickers": 450,
  "completion_percentage": 75,
  "duplicates": 120,
  "missing": 150,
  "wanted": 150
}
```

**Security:** SECURITY DEFINER

---

#### `get_completion_report` _(v1.3.0)_

Generates per-page completion report.

```sql
FUNCTION get_completion_report(
  p_user_id UUID,
  p_collection_id INTEGER
) RETURNS JSON
```

**Returns:**

```json
{
  "collection_id": 1,
  "pages": [
    {
      "page_id": 1,
      "title": "FC Barcelona",
      "kind": "team",
      "order_index": 1,
      "missing": [1, 5, 12],
      "repes": [3, 7, 15]
    }
  ]
}
```

**Security:** SECURITY DEFINER, requires caller = `p_user_id`

---

### Sticker Management

#### `bulk_add_stickers_by_numbers` _(v1.3.0)_

Add multiple stickers by their numbers in one operation.

```sql
FUNCTION bulk_add_stickers_by_numbers(
  p_user_id UUID,
  p_collection_id INTEGER,
  p_numbers INTEGER[]
) RETURNS JSON
```

**Returns:**

```json
{
  "added": 5,
  "duplicates": [12, 15],
  "invalid": [999]
}
```

**Security:** SECURITY DEFINER, requires caller = `p_user_id`

---

#### `search_stickers` _(v1.3.0)_

Search stickers with filters and ownership status.

```sql
FUNCTION search_stickers(
  p_collection_id INTEGER,
  p_query TEXT,
  p_filters JSONB
) RETURNS SETOF sticker_search_result
```

**Filters:**

```json
{
  "owned": true,
  "missing": false,
  "repes": true,
  "kind": "team"
}
```

**Security:** SECURITY DEFINER, authenticated users only

---

### Trading - Discovery

#### `find_mutual_traders`

Find users with mutual trading opportunities. Sticker intent is now inferred from inventory counts: a sticker is missing when the seeker has `count = 0`, and a tradeable duplicate when the owner has `count > 1`.

```sql
FUNCTION find_mutual_traders(
  p_user_id UUID,
  p_collection_id INTEGER,
  p_rarity TEXT DEFAULT NULL,
  p_team TEXT DEFAULT NULL,
  p_query TEXT DEFAULT NULL,
  p_min_overlap INTEGER DEFAULT 1,
  p_limit INTEGER DEFAULT 20,
  p_offset INTEGER DEFAULT 0
) RETURNS TABLE (
  match_user_id UUID,
  nickname TEXT,
  overlap_from_them_to_me BIGINT,
  overlap_from_me_to_them BIGINT,
  total_mutual_overlap BIGINT
)
```

**Security:** SECURITY DEFINER

---

#### `get_mutual_trade_detail`

Get detailed sticker lists for a trading pair. Rows are emitted with `direction = 'they_offer'` when the other user has duplicates (`count > 1`) and you have none, and `direction = 'i_offer'` for the inverse.

```sql
FUNCTION get_mutual_trade_detail(
  p_user_id UUID,
  p_other_user_id UUID,
  p_collection_id INTEGER
) RETURNS TABLE (
  direction TEXT,
  sticker_id INTEGER,
  sticker_code TEXT,
  player_name TEXT,
  team_name TEXT,
  rarity TEXT,
  count INTEGER
)
```

**Security:** SECURITY DEFINER

---

### Trading - Proposals

#### `create_trade_proposal`

Create a new trade proposal.

```sql
FUNCTION create_trade_proposal(
  p_collection_id INTEGER,
  p_to_user UUID,
  p_message TEXT,
  p_offer_items JSONB,
  p_request_items JSONB
) RETURNS JSON
```

**Returns:**

```json
{
  "proposal_id": 123
}
```

**Security:** SECURITY DEFINER

---

#### `respond_to_trade_proposal`

Accept, reject, or cancel a proposal.

```sql
FUNCTION respond_to_trade_proposal(
  p_proposal_id INTEGER,
  p_action TEXT
) RETURNS JSON
```

**Actions:** `'accept'`, `'reject'`, `'cancel'`

**Security:** SECURITY DEFINER

---

#### `list_trade_proposals`

List inbox or outbox proposals.

```sql
FUNCTION list_trade_proposals(
  p_user_id UUID,
  p_box TEXT,
  p_limit INTEGER DEFAULT 20,
  p_offset INTEGER DEFAULT 0
) RETURNS TABLE (...)
```

**Box:** `'inbox'` or `'outbox'`

**Security:** SECURITY DEFINER

---

#### `get_trade_proposal_detail`

Get complete proposal details.

```sql
FUNCTION get_trade_proposal_detail(
  p_proposal_id INTEGER
) RETURNS JSON
```

**Security:** SECURITY DEFINER

---

### Trading - History

#### `complete_trade` _(v1.3.0)_

Mark a trade as completed.

```sql
FUNCTION complete_trade(
  p_trade_id BIGINT
) RETURNS VOID
```

**Security:** SECURITY DEFINER, only participants

---

#### `cancel_trade` _(v1.3.0)_

Cancel a trade.

```sql
FUNCTION cancel_trade(
  p_trade_id BIGINT
) RETURNS VOID
```

**Security:** SECURITY DEFINER, only participants

---

## Triggers

### `handle_updated_at`

Automatically updates `updated_at` column on row modifications.

Applied to:

- `profiles`
- `user_stickers`
- `trade_proposals`

---

## Supabase Storage Buckets

### `sticker-images`

Stores sticker artwork.

**Structure:**

```
sticker-images/
├── {collection_id}/
│   ├── {sticker_number}-{sticker_id}.webp (300px)
│   └── thumbs/
│       └── {sticker_number}-{sticker_id}.webp (100px)
```

**Configuration:**

- Public read access
- Authenticated write only
- Max file size: 5MB
- Allowed MIME types: `image/webp`, `image/png`, `image/jpeg`

---

### `avatars`

Stores user profile avatars.

**Configuration:**

- Public read access
- Authenticated write only
- Max file size: 2MB
- Allowed MIME types: `image/webp`, `image/png`, `image/jpeg`

---

## Migration Notes

### Deployment Checklist

1. ✅ All core tables created
2. ✅ All indexes applied
3. ✅ All RLS policies active
4. ✅ All RPC functions deployed
5. ✅ Storage buckets configured
6. ⚠️ Backfill `stickers.sticker_number` before enforcing NOT NULL
7. ⚠️ Populate `collection_pages` and `page_slots` for active collections

### Performance Monitoring

Key indexes for monitoring:

- `idx_user_stickers_trading_v2` (Phase 1 high traffic)
- `idx_user_stickers_trading` (kept during transition)
- `idx_stickers_collection_filters` (trading queries)
- `idx_trade_proposals_to_user` (inbox queries)
- `idx_collection_pages_order` (album navigation)

---

## Schema Version History

- **v1.3.0** (Current): Album pages, trade history, badges, enhanced sticker images
- **v1.2.0**: Complete trade proposals system
- **v1.1.0**: Trading discovery (find mutual traders)
- **v1.0.0**: Core collection and sticker management

---

**Status:** ✅ All v1.3.0 features deployed and documented
**Next:** Begin Phase 2 continuation (chat UI, history dashboard)
